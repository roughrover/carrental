pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/roughrover/carrental.git'
            }
        }

        stage('Deploy with Docker Compose') {
            steps {
                sh '''
                    if [ "$(docker ps -aq -f name=^jenkins$)" ]; then
                        echo "Jenkins container exists. Skipping Jenkins service start."
                        # Stop and remove only non-Jenkins containers
                        docker compose stop mysql_db carrental-phpmyadmin web || true
                        docker compose rm -f mysql_db carrental-phpmyadmin web || true

                        # Start only non-Jenkins services
                        docker compose up -d --build mysql_db carrental-phpmyadmin web
                    else
                        echo "Jenkins container not found. Starting all containers."
                        docker compose down || true
                        docker compose up -d --build
                    fi
                '''
            }
        }
    }
}
